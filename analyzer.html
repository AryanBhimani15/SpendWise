<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyze Statement - SpendWise</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,1000&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/sections.css">
    <link rel="stylesheet" href="css/animations.css">
    <style>
        /* Upload Section Styles */
        .upload-section {
            padding: 140px 5% 100px;
            background: var(--bg-warm);
            min-height: 70vh;
            display: flex;
            align-items: center;
        }

        .upload-container {
            max-width: 700px;
            margin: 0 auto;
            text-align: center;
            width: 100%;
        }

        .upload-container h2 {
            font-size: 42px;
            color: var(--brown);
            margin-bottom: 16px;
            font-family: 'DM Sans', sans-serif;
        }

        .upload-container > p {
            font-size: 18px;
            color: var(--text-light);
            margin-bottom: 48px;
            line-height: 1.6;
        }

        .cascade-container {
            margin-bottom: 40px;
            text-align: left;
            background: var(--surface);
            border-radius: 24px;
            padding: 32px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
        }

        .cascade-step {
            margin-bottom: 24px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .cascade-step.active {
            opacity: 1;
            transform: translateY(0);
        }

        .cascade-step:last-child {
            margin-bottom: 0;
        }

        .cascade-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
        }

        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-trigger {
            width: 100%;
            padding: 20px 24px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            color: var(--text);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .dropdown-trigger:hover {
            border-color: var(--accent);
            background: var(--surface);
        }

        .dropdown-trigger.active {
            border-color: var(--brown);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .dropdown-trigger .placeholder {
            color: var(--text-light);
        }

        .dropdown-arrow {
            width: 20px;
            height: 20px;
            transition: transform 0.3s;
            color: var(--text-light);
        }

        .dropdown-trigger.active .dropdown-arrow {
            transform: rotate(180deg);
            color: var(--brown);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 16px;
            max-height: 320px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 100;
            box-shadow: 0 20px 60px rgba(0,0,0,0.12);
        }

        .dropdown-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 18px 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: var(--bg-warm);
        }

        .dropdown-item.selected {
            background: rgba(212, 165, 116, 0.1);
        }

        .item-main {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .item-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--brown);
        }

        .item-subtitle {
            font-size: 13px;
            color: var(--text-light);
        }

        .bank-indicator {
            width: 4px;
            height: 40px;
            border-radius: 2px;
            margin-right: 16px;
        }

        .bank-sbi { background: #1e7e34; }
        .bank-hdfc { background: #004c8f; }
        .bank-axis { background: #9e1b32; }
        .bank-icici { background: #c41230; }
        .bank-idfc { background: #e31837; }
        .bank-kotak { background: #005f9e; }
        .bank-amex { background: #006fcf; }
        .bank-rbl { background: #6b2d5c; }
        .bank-other { background: var(--text-light); }

        .selected-card-display {
            background: linear-gradient(135deg, var(--brown) 0%, #3d3226 100%);
            border-radius: 20px;
            padding: 28px;
            margin-top: 8px;
            display: none;
            animation: slideUp 0.4s ease;
        }

        .selected-card-display.active {
            display: block;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .selected-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .selected-card-bank {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: rgba(255,255,255,0.7);
        }

        .selected-card-change {
            font-size: 13px;
            color: var(--accent);
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
            padding: 0;
        }

        .selected-card-change:hover {
            text-decoration: underline;
        }

        .selected-card-name {
            font-family: 'DM Sans', sans-serif;
            font-size: 24px;
            color: white;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .selected-card-type {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
        }

        .upload-zone {
            border: 3px dashed var(--border);
            border-radius: 28px;
            padding: 60px 40px;
            background: var(--surface);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: none;
        }

        .upload-zone.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--accent);
            transform: translateY(-4px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }

        .upload-zone:hover::before,
        .upload-zone.dragover::before {
            opacity: 1;
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            background: var(--bg-warm);
            border-radius: 20px;
            display: grid;
            place-items: center;
            margin: 0 auto 24px;
            color: var(--brown);
            transition: all 0.3s;
        }

        .upload-zone:hover .upload-icon {
            background: var(--accent);
            color: white;
            transform: scale(1.1);
        }

        .upload-icon svg {
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            width: 32px;
            height: 32px;
        }

        .upload-text {
            font-size: 20px;
            color: var(--brown);
            font-weight: 600;
            margin-bottom: 8px;
            font-family: 'DM Sans', sans-serif;
        }

        .upload-subtitle {
            font-size: 15px;
            color: var(--text-light);
        }

        .upload-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .dashboard-main {
            display: none;
            padding: 120px 5% 60px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-main.active {
            display: block;
            animation: fadeIn 0.6s ease;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 48px;
            position: relative;
        }

        .trust-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(124, 154, 107, 0.1);
            border: 1px solid rgba(124, 154, 107, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--green);
            margin-bottom: 16px;
            font-weight: 500;
        }

        .trust-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--green);
            border-radius: 50%;
        }

        .dashboard-header h1 {
            font-size: 48px;
            color: var(--brown);
            margin-bottom: 8px;
        }

        .dashboard-header p {
            font-size: 18px;
            color: var(--text-light);
        }

        .dashboard-header-actions {
            position: absolute;
            top: 0;
            right: 0;
        }

        .btn-reset {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--brown);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'DM Sans', sans-serif;
        }

        .btn-reset:hover {
            background: var(--accent);
            color: var(--brown);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        @media (max-width: 768px) {
            .dashboard-header-actions {
                position: static;
                margin-top: 20px;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'DM Sans', sans-serif;
            font-size: 36px;
            font-weight: 600;
            color: var(--brown);
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive { color: var(--green); }
        .stat-change.negative { color: var(--red); }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 20px;
            color: var(--brown);
        }

        .pie-chart-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        .pie-chart-container {
            position: relative;
            width: 280px;
            height: 280px;
        }

        .pie-chart-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .pie-segment {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            transform-origin: center;
        }

        .pie-segment:hover {
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.2));
            transform: scale(1.05);
            z-index: 10;
        }

        .pie-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            background: var(--surface);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05), 0 4px 20px rgba(0,0,0,0.1);
            border: 2px solid var(--border);
            pointer-events: none;
            z-index: 5;
        }

        .pie-center-value {
            font-family: 'DM Sans', sans-serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--brown);
            line-height: 1;
            margin-bottom: 4px;
        }

        .pie-center-label {
            font-size: 11px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pie-tooltip {
            position: absolute;
            background: var(--brown);
            color: var(--bg);
            padding: 12px 18px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: all 0.2s ease;
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .pie-tooltip.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 100%;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-warm);
            border-radius: 10px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            cursor: pointer;
        }

        .legend-item:hover {
            background: var(--surface);
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .legend-text {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .legend-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--brown);
        }

        .legend-percent {
            font-size: 11px;
            color: var(--text-light);
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 200px;
            gap: 12px;
            padding: 20px 0;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            height: 100%;
            justify-content: flex-end;
        }

        .bar-value {
            font-size: 12px;
            color: var(--brown);
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .bar-value.show {
            opacity: 1;
        }

        .bar-track {
            width: 100%;
            height: 140px;
            background: var(--bg-warm);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--accent), var(--accent-dark));
            border-radius: 8px 8px 0 0;
            transition: height 1s cubic-bezier(0.23, 1, 0.32, 1);
            height: 0%;
        }

        .bar-label {
            font-size: 12px;
            color: var(--text-light);
            font-weight: 500;
        }

        .recommendations-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 40px;
        }

        .section-header {
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-size: 24px;
            color: var(--brown);
            margin-bottom: 8px;
        }

        .section-header p {
            font-size: 15px;
            color: var(--text-light);
        }

        .recommendation-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .rec-card {
            background: var(--bg-warm);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .rec-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
            border-color: var(--accent);
        }

        .rec-card.best {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.1) 0%, rgba(212, 165, 116, 0.05) 100%);
            border-color: var(--accent);
        }

        .rec-card.current {
            border-color: var(--green);
        }

        .rec-rank {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            background: var(--brown);
            color: white;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 700;
        }

        .rec-card.best .rec-rank {
            background: var(--accent);
            color: var(--brown);
        }

        .rec-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--brown);
            margin-bottom: 4px;
            padding-right: 40px;
        }

        .rec-bank {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 16px;
        }

        .rec-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .rec-stat {
            text-align: center;
            padding: 12px;
            background: var(--surface);
            border-radius: 10px;
        }

        .rec-stat-value {
            display: block;
            font-family: 'DM Sans', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--brown);
            margin-bottom: 2px;
        }

        .rec-stat-value.positive {
            color: var(--green);
        }

        .rec-stat-label {
            font-size: 11px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rec-fee {
            font-size: 13px;
            color: var(--text-light);
            text-align: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .current-badge {
            position: absolute;
            top: 16px;
            left: 16px;
            background: var(--green);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .transactions-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            overflow: hidden;
        }

        .table-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
        }

        .table-header-cell {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 16px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .table-row:hover {
            background: var(--bg-warm);
            margin: 0 -32px;
            padding-left: 32px;
            padding-right: 32px;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .merchant-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .merchant-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-warm);
            border-radius: 8px;
            display: grid;
            place-items: center;
            font-size: 16px;
        }

        .merchant-name {
            font-weight: 500;
            color: var(--text);
        }

        .category-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--bg-warm);
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-light);
            text-transform: capitalize;
        }

        .amount-cell {
            font-weight: 600;
            color: var(--brown);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .legal-disclaimer {
            background: var(--bg-warm);
            border-top: 1px solid var(--border);
            padding: 24px 5%;
            margin-top: 40px;
        }

        .legal-disclaimer p {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.6;
        }

        .eligibility-notice {
            background: rgba(212, 165, 116, 0.1);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            font-size: 13px;
            color: var(--text);
        }

        .eligibility-notice strong {
            color: var(--brown);
        }

        .no-data-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .no-data-state h3 {
            font-size: 20px;
            color: var(--brown);
            margin-bottom: 8px;
        }

        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
            .recommendation-cards { grid-template-columns: 1fr; }
            .cascade-container { padding: 24px; }
        }

        @media (max-width: 768px) {
            .dashboard-header h1 { font-size: 32px; }
            .stats-grid { grid-template-columns: 1fr; }
            .table-header, .table-row { grid-template-columns: 1fr; gap: 8px; }
            .upload-container h2 { font-size: 32px; }
            .dropdown-menu { max-height: 280px; }
        }
    </style>
<base target="_blank">
<base target="_blank">
</head>
<body>
    <script>
        function populateCards() {}
        function initScrollProgress() {}
    </script>
    <nav id="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">SpendWise</a>
            <ul class="nav-links">
                <li><a href="analyzer.html">Analyze</a></li>
                <li><a href="best-credit-cards-india.html">Best Cards</a></li>
                <li><a href="compare-cards.html">Compare</a></li>
                <li><a href="credit-card-quiz.html">Quiz</a></li>
            </ul>
            <button class="nav-cta" onclick="resetAnalysis()">Analyze New</button>
        </div>
    </nav>

    <section class="upload-section" id="uploadSection">
        <div class="upload-container">
            <span class="section-label">Privacy-First Analysis</span>
            <h2>Select Your Card & Upload</h2>
            <p>Choose your bank and credit card, then upload your statement. We will analyze your spending and find better rewards.</p>

            <div class="cascade-container" id="cascadeContainer">
                <div class="cascade-step active" id="stepBank">
                    <label class="cascade-label">Step 1: Select Your Bank</label>
                    <div class="custom-dropdown" id="bankDropdown">
                        <div class="dropdown-trigger" onclick="toggleDropdown('bank')">
                            <span class="placeholder" id="bankPlaceholder">Choose your bank...</span>
                            <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                        <div class="dropdown-menu" id="bankMenu"></div>
                    </div>
                </div>

                <div class="cascade-step" id="stepCard">
                    <label class="cascade-label">Step 2: Select Your Card</label>
                    <div class="custom-dropdown" id="cardDropdown">
                        <div class="dropdown-trigger" onclick="toggleDropdown('card')">
                            <span class="placeholder" id="cardPlaceholder">Choose your card...</span>
                            <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                        <div class="dropdown-menu" id="cardMenu"></div>
                    </div>
                </div>

                <div class="selected-card-display" id="selectedCardDisplay">
                    <div class="selected-card-header">
                        <span class="selected-card-bank" id="displayBank">BANK</span>
                        <button class="selected-card-change" onclick="resetSelection()">Change</button>
                    </div>
                    <div class="selected-card-name" id="displayCard">Card Name</div>
                    <div class="selected-card-type" id="displayType">Card Type</div>
                </div>
            </div>

            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </div>
                <div class="upload-text">Drop your statement here</div>
                <div class="upload-subtitle">or click to browse (PDF, CSV, Excel)</div>
            </div>

            <input type="file" id="fileInput" style="display: none;" accept=".pdf,.csv,.xlsx,.xls">
        </div>
    </section>

    <div class="dashboard-main" id="dashboardMain">
        <div class="dashboard-header">
            <div class="dashboard-header-actions">
                <button class="btn-reset" onclick="resetAnalysis()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    Analyze New
                </button>
            </div>
            <div class="trust-badge">Analysis Complete</div>
            <h1>Your Spending Dashboard</h1>
            <p>Here is what we found in your statement and how you can optimize</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Spent</div>
                <div class="stat-value" id="statTotal">₹0</div>
                <div class="stat-change positive">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                    </svg>
                    This statement period
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Rewards Missed</div>
                <div class="stat-value" id="statMissed" style="color: var(--red);">₹0</div>
                <div class="stat-change negative">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>
                    </svg>
                    With better cards
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Potential Annual Savings</div>
                <div class="stat-value" id="statSavings" style="color: var(--green);">₹0</div>
                <div class="stat-change positive">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                    </svg>
                    Switch to recommended
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Transactions</div>
                <div class="stat-value" id="statTxns">0</div>
                <div class="stat-change positive">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                    </svg>
                    Analyzed
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Spending by Category</h3>
                </div>
                <div class="pie-chart-wrapper">
                    <div class="pie-chart-container" id="pieContainer">
                        <svg class="pie-chart-svg" viewBox="0 0 100 100" id="pieSvg"></svg>
                        <div class="pie-center">
                            <div class="pie-center-value" id="pieCenterValue">₹0</div>
                            <div class="pie-center-label">Total Spent</div>
                        </div>
                        <div class="pie-tooltip" id="pieTooltip"></div>
                    </div>
                    <div class="pie-legend" id="pieLegend"></div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Monthly Trend</h3>
                </div>
                <div class="bar-chart" id="barChart">
                    <div class="bar-item">
                        <div class="bar-value" id="barVal1">₹0</div>
                        <div class="bar-track"><div class="bar-fill" id="barFill1"></div></div>
                        <div class="bar-label" id="barLabel1">-</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-value" id="barVal2">₹0</div>
                        <div class="bar-track"><div class="bar-fill" id="barFill2"></div></div>
                        <div class="bar-label" id="barLabel2">-</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-value" id="barVal3">₹0</div>
                        <div class="bar-track"><div class="bar-fill" id="barFill3"></div></div>
                        <div class="bar-label" id="barLabel3">-</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-value" id="barVal4">₹0</div>
                        <div class="bar-track"><div class="bar-fill" id="barFill4"></div></div>
                        <div class="bar-label" id="barLabel4">-</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-value" id="barVal5">₹0</div>
                        <div class="bar-track"><div class="bar-fill" id="barFill5"></div></div>
                        <div class="bar-label" id="barLabel5">-</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-value" id="barVal6">₹0</div>
                        <div class="bar-track"><div class="bar-fill" id="barFill6"></div></div>
                        <div class="bar-label" id="barLabel6">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="recommendations-section">
            <div class="section-header">
                <h2>Recommended Cards For You</h2>
                <p>Based on your spending pattern, these cards could earn you more rewards</p>
            </div>
            <div class="eligibility-notice">
                <strong>Important:</strong> Eligibility criteria (age, income, credit score) are based on publicly stated requirements. 
                Final approval is solely at the issuing bank's discretion. SpendWise does not guarantee approval.
            </div>
            <div class="recommendation-cards" id="recommendationCards"></div>
        </div>

        <div class="transactions-section">
            <div class="section-header">
                <h2>Recent Transactions</h2>
                <p>Your latest spending activity</p>
            </div>
            <div class="table-header">
                <div class="table-header-cell">Merchant</div>
                <div class="table-header-cell">Category</div>
                <div class="table-header-cell">Date</div>
                <div class="table-header-cell">Amount</div>
            </div>
            <div id="transactionsList"></div>
        </div>
    </div>

    <div class="legal-disclaimer">
        <p>
            <strong>Disclaimer:</strong> SpendWise provides informational analysis based on publicly available reward structures. 
            Reward calculations are estimates based on your uploaded statement data. Actual rewards may vary based on 
            merchant MCC codes, bank promotions, and specific card terms. Final approval and card terms are decided 
            solely by issuing banks. SpendWise is not a financial advisor—please verify all rates with official bank sources.
        </p>
    </div>

    <div id="toast"></div>

    <script src="js/main.js"></script>
    <script>

        // ============================================
        // DATA NORMALIZATION LAYER
        // ============================================

        function extractPercentage(value) {
            if (typeof value === 'string' && value.includes('%')) {
                const num = parseFloat(value.replace('%', '').trim());
                return isNaN(num) ? null : num / 100;
            }
            return null;
        }

        function extractRP(value, pointValue) {
            if (!pointValue || typeof value !== 'string') return null;

            const rpPerSpendMatch = value.match(/(\d+(?:\.\d+)?)\s*RP\/₹(\d+)/i);
            if (rpPerSpendMatch) {
                const rp = parseFloat(rpPerSpendMatch[1]);
                const spend = parseFloat(rpPerSpendMatch[2]);
                return (rp * pointValue) / spend;
            }

            const rpMatch = value.match(/(\d+(?:\.\d+)?)\s*(?:RP|X)/i);
            if (rpMatch) {
                const rp = parseFloat(rpMatch[1]);
                return (rp * pointValue) / 100;
            }

            return null;
        }

        function normalizeCard(rawCard) {
            const pointValue = parseFloat(rawCard.point_value) || 1;

            const normalized = {
                card_id: rawCard.card_id,
                card_name: rawCard.card_name,
                bank: rawCard.bank,
                annual_fee: parseFloat(rawCard.annual_fee) || 0,
                reward_model: rawCard.reward_model || 'cashback',
                point_value: pointValue,
                categories: {},
                caps: rawCard.caps || {},
                forex_markup: parseFloat(rawCard.forex_markup) || 0.035,
                lounge: parseInt(rawCard.lounge) || 0,
                redemption_multiplier: rawCard.redemption_multiplier || { cash: 1.0, travel: 1.0 },
                eligibility: rawCard.eligibility || {
                    min_age: 21,
                    min_income: 20000,
                    min_cibil: 650
                }
            };

            if (rawCard.categories) {
                for (const [cat, value] of Object.entries(rawCard.categories)) {
                    let rate = extractPercentage(value);
                    if (rate === null) {
                        rate = extractRP(value, pointValue);
                    }
                    if (rate === null && !isNaN(parseFloat(value))) {
                        rate = parseFloat(value);
                    }
                    if (rate !== null) {
                        normalized.categories[cat] = rate;
                    }
                }
            }

            return normalized;
        }

        const RAW_CARD_DATABASE = [
            {
                card_id: "sbi_simplyclick",
                card_name: "SBI SimplyCLICK",
                bank: "SBI Card",
                annual_fee: 499,
                reward_model: "points",
                point_value: 0.20,
                categories: {
                    online_partners: "10 RP/₹100",
                    online: "5 RP/₹100",
                    general: "1 RP/₹100"
                },
                caps: { online_monthly: 10000 },
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 0.8, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 20000, min_cibil: 650 }
            },
            {
                card_id: "sbi_cashback",
                card_name: "SBI Cashback Card",
                bank: "SBI Card",
                annual_fee: 999,
                reward_model: "cashback",
                point_value: 1,
                categories: { online: "0.05", general: "0.01" },
                caps: { online_monthly: 5000 },
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 25000, min_cibil: 700 }
            },
            {
                card_id: "hdfc_swiggy",
                card_name: "HDFC Swiggy",
                bank: "HDFC Bank",
                annual_fee: 500,
                reward_model: "cashback",
                point_value: 1,
                categories: { food_dining: "0.10", online: "0.05", general: "0.01" },
                caps: { food_dining_monthly: 1500 },
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 21, min_income: 25000, min_cibil: 700 }
            },
            {
                card_id: "hdfc_millennia",
                card_name: "HDFC Millennia",
                bank: "HDFC Bank",
                annual_fee: 1000,
                reward_model: "cashback",
                point_value: 1,
                categories: { shopping: "0.05", general: "0.01" },
                caps: { shopping_monthly: 1000 },
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 21, min_income: 30000, min_cibil: 700 }
            },
            {
                card_id: "hdfc_infinia",
                card_name: "HDFC Infinia Metal",
                bank: "HDFC Bank",
                annual_fee: 12500,
                reward_model: "points",
                point_value: 1.0,
                categories: {
                    general: "0.033",
                    smartbuy_hotels: "0.10",
                    smartbuy_flights: "0.05",
                    smartbuy_vouchers: "0.05"
                },
                caps: { general_monthly: 15000, smartbuy_monthly: 15000 },
                forex_markup: 0.02,
                lounge: 999,
                redemption_multiplier: { cash: 0.5, travel: 1.0 },
                eligibility: { min_age: 21, min_income: 120000, min_cibil: 750 }
            },
            {
                card_id: "axis_flipkart",
                card_name: "Axis Flipkart",
                bank: "Axis Bank",
                annual_fee: 500,
                reward_model: "cashback",
                point_value: 1,
                categories: {
                    shopping_myntra: "0.075",
                    shopping_flipkart: "0.05",
                    shopping_cleartrip: "0.05",
                    preferred: "0.04",
                    general: "0.01"
                },
                caps: { shopping_quarterly: 4000 },
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 15000, min_cibil: 650 }
            },
            {
                card_id: "axis_ace",
                card_name: "Axis ACE",
                bank: "Axis Bank",
                annual_fee: 499,
                reward_model: "cashback",
                point_value: 1,
                categories: { utilities: "0.05", food_dining: "0.04", general: "0.02" },
                caps: { utilities_monthly: 500 },
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 20000, min_cibil: 650 }
            },
            {
                card_id: "axis_magnus",
                card_name: "Axis Magnus",
                bank: "Axis Bank",
                annual_fee: 12500,
                reward_model: "points",
                point_value: 0.20,
                categories: { general: "0.012" },
                caps: { general_monthly: 15000 },
                forex_markup: 0.02,
                lounge: 999,
                redemption_multiplier: { cash: 0.8, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 100000, min_cibil: 750 }
            },
            {
                card_id: "icici_amazon",
                card_name: "ICICI Amazon Pay",
                bank: "ICICI Bank",
                annual_fee: 0,
                reward_model: "cashback",
                point_value: 1,
                categories: { shopping: "0.05", general: "0.01" },
                caps: { shopping_monthly: 1500 },
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 25000, min_cibil: 650 }
            },
            {
                card_id: "icici_coral",
                card_name: "ICICI Coral",
                bank: "ICICI Bank",
                annual_fee: 500,
                reward_model: "points",
                point_value: 0.25,
                categories: { food_dining: "0.025", general: "0.01" },
                caps: {},
                forex_markup: 0.035,
                lounge: 1,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 21, min_income: 30000, min_cibil: 700 }
            },
            {
                card_id: "idfc_millennia",
                card_name: "IDFC FIRST Millennia",
                bank: "IDFC FIRST Bank",
                annual_fee: 0,
                reward_model: "points",
                point_value: 0.25,
                categories: { online: "0.025", general: "0.01" },
                caps: {},
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 20000, min_cibil: 650 }
            },
            {
                card_id: "idfc_wealth",
                card_name: "IDFC FIRST Wealth",
                bank: "IDFC FIRST Bank",
                annual_fee: 0,
                reward_model: "points",
                point_value: 0.25,
                categories: { general: "0.025" },
                caps: {},
                forex_markup: 0.015,
                lounge: 4,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 50000, min_cibil: 700 }
            },
            {
                card_id: "kotak_811",
                card_name: "Kotak 811 #DreamDifferent",
                bank: "Kotak Mahindra",
                annual_fee: 499,
                reward_model: "cashback",
                point_value: 1,
                categories: { general: "0.01" },
                caps: {},
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 15000, min_cibil: 650 }
            },
            {
                card_id: "kotak_myntra",
                card_name: "Myntra Kotak",
                bank: "Kotak Mahindra",
                annual_fee: 500,
                reward_model: "cashback",
                point_value: 1,
                categories: { shopping: "0.10", general: "0.01" },
                caps: { shopping_monthly: 1000 },
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 20000, min_cibil: 650 }
            },
            {
                card_id: "amex_smartearn",
                card_name: "Amex SmartEarn",
                bank: "American Express",
                annual_fee: 495,
                reward_model: "points",
                point_value: 0.25,
                categories: { shopping: "0.05", general: "0.01" },
                caps: { shopping_monthly: 250 },
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 0.8, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 40000, min_cibil: 700 }
            },
            {
                card_id: "amex_mrcc",
                card_name: "Amex MRCC",
                bank: "American Express",
                annual_fee: 4500,
                reward_model: "points",
                point_value: 0.40,
                categories: { general: "0.01" },
                caps: {},
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 0.7, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 60000, min_cibil: 750 }
            },
            {
                card_id: "rbl_shoprite",
                card_name: "RBL Shoprite",
                bank: "RBL Bank",
                annual_fee: 500,
                reward_model: "points",
                point_value: 0.25,
                categories: { shopping: "0.01", general: "0.01" },
                caps: {},
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 20000, min_cibil: 650 }
            },
            {
                card_id: "other",
                card_name: "Other / Not Listed",
                bank: "Other",
                annual_fee: 0,
                reward_model: "cashback",
                point_value: 1,
                categories: { general: "0.01" },
                caps: {},
                forex_markup: 0.035,
                lounge: 0,
                redemption_multiplier: { cash: 1.0, travel: 1.0 },
                eligibility: { min_age: 18, min_income: 0, min_cibil: 0 }
            }
        ];

        const CARD_DATABASE_NORMALIZED = {};
        RAW_CARD_DATABASE.forEach(card => {
            CARD_DATABASE_NORMALIZED[card.card_id] = normalizeCard(card);
        });

        const CARD_DATABASE = {};
        RAW_CARD_DATABASE.forEach(card => {
            if (!CARD_DATABASE[card.bank]) {
                CARD_DATABASE[card.bank] = [];
            }
            CARD_DATABASE[card.bank].push({
                id: card.card_id,
                name: card.card_name,
                type: card.reward_model === 'cashback' ? 'Cashback' : 'Rewards',
                rewards: Object.entries(card.categories).map(([k, v]) => {
                    const rate = extractPercentage(v) || extractRP(v, card.point_value) || parseFloat(v);
                    return `${(rate * 100).toFixed(0)}% ${k}`;
                }).join(', ')
            });
        });

        function applyCaps(reward, capData, spendAmount) {
            if (!capData) return reward;
            if (capData.monthly_limit !== undefined && reward > capData.monthly_limit) {
                return capData.monthly_limit;
            }
            if (capData.quarterly_limit !== undefined) {
                const monthlyFromQuarterly = capData.quarterly_limit / 3;
                if (reward > monthlyFromQuarterly) {
                    return monthlyFromQuarterly;
                }
            }
            if (capData.max_percent !== undefined) {
                const maxReward = spendAmount * capData.max_percent;
                if (reward > maxReward) {
                    return maxReward;
                }
            }
            return reward;
        }

        function applyRedemptionMultiplier(rawReward, card, redemptionMethod) {
            if (!card.redemption_multiplier) return rawReward;
            const multiplier = card.redemption_multiplier[redemptionMethod] || 1.0;
            return rawReward * multiplier;
        }

        function calculateCardRewards(cardId, categoryTotals, redemptionMethod) {
            const card = CARD_DATABASE_NORMALIZED[cardId] || CARD_DATABASE_NORMALIZED['other'];
            let monthlyRewards = 0;
            let categoryBreakdown = {};
            let totalCapped = false;

            for (const [category, amount] of Object.entries(categoryTotals)) {
                let rate = card.categories[category] || card.categories['general'] || 0.01;
                let reward = amount * rate;
                let capped = false;

                const capKey = `${category}_monthly`;
                if (card.caps && card.caps[capKey]) {
                    const beforeCap = reward;
                    reward = Math.min(reward, card.caps[capKey]);
                    if (reward < beforeCap) capped = true;
                }

                reward = applyRedemptionMultiplier(reward, card, redemptionMethod);
                monthlyRewards += reward;
                categoryBreakdown[category] = {
                    spend: amount,
                    rate: rate,
                    raw_reward: amount * rate,
                    reward: reward,
                    capped: capped,
                    redemption_method: redemptionMethod
                };
            }

            if (card.caps && card.caps.general_monthly) {
                if (monthlyRewards > card.caps.general_monthly) {
                    monthlyRewards = card.caps.general_monthly;
                    totalCapped = true;
                }
            }

            const annualRewards = monthlyRewards * 12;
            const netBenefit = annualRewards - card.annual_fee;

            return {
                card_id: card.card_id,
                card_name: card.card_name,
                annual_fee: card.annual_fee,
                monthly_rewards: monthlyRewards,
                annual_rewards: annualRewards,
                net_annual_benefit: netBenefit,
                category_breakdown: categoryBreakdown,
                total_capped: totalCapped,
                forex_markup: card.forex_markup,
                eligibility: card.eligibility
            };
        }

        function checkEligibility(card, userProfile) {
            const defaults = { age: 25, income: 50000, cibil: 700 };
            const profile = Object.assign({}, defaults, userProfile);

            const warnings = [];

            if (profile.age < card.eligibility.min_age) {
                warnings.push(`Minimum age requirement: ${card.eligibility.min_age}+ years`);
            }

            if (profile.income < card.eligibility.min_income) {
                warnings.push(`Income requirement: ₹${card.eligibility.min_income.toLocaleString('en-IN')}+/month`);
            }

            if (profile.cibil < card.eligibility.min_cibil) {
                warnings.push(`Credit score: ${card.eligibility.min_cibil}+ recommended`);
            }

            return {
                eligible: true,
                warnings: warnings,
                disclaimer: "Final approval is solely at the issuing bank's discretion."
            };
        }

        function scoreCard(card, spending, userProfile) {
            const rewards = calculateCardRewards(card.card_id, spending, 'cash');
            let score = rewards.net_annual_benefit;

            if (spending.international) {
                const forexPenalty = spending.international * card.forex_markup * 12;
                score -= forexPenalty;
            }

            const eligibility = checkEligibility(card, userProfile);
            if (eligibility.warnings.length > 0) {
                score *= 0.8;
            }

            if (card.annual_fee === 0) {
                score += 500;
            }

            return {
                score: score,
                rewards: rewards,
                eligibility: eligibility
            };
        }

        function findBestCards(categoryTotals, userProfile) {
            const results = [];

            for (const [cardId, card] of Object.entries(CARD_DATABASE_NORMALIZED)) {
                const scored = scoreCard(card, categoryTotals, userProfile);
                results.push({
                    card_id: cardId,
                    card: card,
                    card_name: card.card_name,
                    annual_fee: card.annual_fee,
                    monthly_rewards: scored.rewards.monthly_rewards,
                    annual_rewards: scored.rewards.annual_rewards,
                    net_annual_benefit: scored.rewards.net_annual_benefit,
                    score: scored.score,
                    eligibility: scored.eligibility
                });
            }

            results.sort((a, b) => b.score - a.score);
            return results;
        }

        const BANK_COLORS = {
            "SBI Card": "bank-sbi",
            "HDFC Bank": "bank-hdfc",
            "Axis Bank": "bank-axis",
            "ICICI Bank": "bank-icici",
            "IDFC FIRST Bank": "bank-idfc",
            "Kotak Mahindra": "bank-kotak",
            "American Express": "bank-amex",
            "RBL Bank": "bank-rbl",
            "Other": "bank-other"
        };

        let selectedBank = null;
        let selectedCard = null;
        let selectedCardId = null;

        document.addEventListener('DOMContentLoaded', () => {
            populateBankDropdown();
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-dropdown')) {
                    closeAllDropdowns();
                }
            });
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        });

        function populateBankDropdown() {
            const menu = document.getElementById('bankMenu');
            const banks = Object.keys(CARD_DATABASE).sort((a, b) => {
                if (a === "Other") return 1;
                if (b === "Other") return -1;
                return a.localeCompare(b);
            });

            menu.innerHTML = banks.map(bank => `
                <div class="dropdown-item" onclick="selectBank('${bank}')">
                    <div style="display: flex; align-items: center;">
                        <div class="bank-indicator ${BANK_COLORS[bank] || 'bank-other'}"></div>
                        <div class="item-main">
                            <span class="item-title">${bank}</span>
                            <span class="item-subtitle">${CARD_DATABASE[bank].length} cards</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleDropdown(type) {
            const menu = document.getElementById(type + 'Menu');
            const trigger = document.querySelector(`#${type}Dropdown .dropdown-trigger`);
            const isOpen = menu.classList.contains('open');
            closeAllDropdowns();
            if (!isOpen) {
                menu.classList.add('open');
                trigger.classList.add('active');
            }
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('open'));
            document.querySelectorAll('.dropdown-trigger').forEach(t => t.classList.remove('active'));
        }

        function selectBank(bank) {
            selectedBank = bank;
            selectedCard = null;
            selectedCardId = null;
            document.getElementById('bankPlaceholder').textContent = bank;
            document.getElementById('bankPlaceholder').classList.remove('placeholder');
            closeAllDropdowns();
            document.getElementById('stepCard').classList.add('active');
            populateCardDropdown(bank);
            document.getElementById('cardPlaceholder').textContent = 'Choose your card...';
            document.getElementById('cardPlaceholder').classList.add('placeholder');
            document.getElementById('selectedCardDisplay').classList.remove('active');
            document.getElementById('uploadZone').classList.remove('active');
            showToast(`${bank} selected — now choose your card`);
        }

        function populateCardDropdown(bank) {
            const menu = document.getElementById('cardMenu');
            const cards = CARD_DATABASE[bank] || [];
            menu.innerHTML = cards.map((card, idx) => `
                <div class="dropdown-item" onclick="selectCard('${bank}', ${idx})">
                    <div class="item-main">
                        <span class="item-title">${card.name}</span>
                        <span class="item-subtitle">${card.type} • ${card.rewards}</span>
                    </div>
                </div>
            `).join('');
        }

        function selectCard(bank, cardIndex) {
            const card = CARD_DATABASE[bank][cardIndex];
            selectedCard = card;
            selectedCardId = card.id;
            document.getElementById('cardPlaceholder').textContent = card.name;
            document.getElementById('cardPlaceholder').classList.remove('placeholder');
            closeAllDropdowns();
            document.getElementById('displayBank').textContent = bank;
            document.getElementById('displayCard').textContent = card.name;
            document.getElementById('displayType').textContent = `${card.type} • ${card.rewards}`;
            document.getElementById('selectedCardDisplay').classList.add('active');
            document.getElementById('uploadZone').classList.add('active');
            localStorage.setItem('cardmax_selected_bank', bank);
            localStorage.setItem('cardmax_selected_card', JSON.stringify(card));
            localStorage.setItem('cardmax_selected_card_id', card.id);
            showToast(`${card.name} selected — upload your statement`);
        }

        function resetSelection() {
            selectedBank = null;
            selectedCard = null;
            selectedCardId = null;
            document.getElementById('bankPlaceholder').textContent = 'Choose your bank...';
            document.getElementById('bankPlaceholder').classList.add('placeholder');
            document.getElementById('stepCard').classList.remove('active');
            document.getElementById('selectedCardDisplay').classList.remove('active');
            document.getElementById('uploadZone').classList.remove('active');
            localStorage.removeItem('cardmax_selected_bank');
            localStorage.removeItem('cardmax_selected_card');
            localStorage.removeItem('cardmax_selected_card_id');
            showToast('Selection reset — start over');
        }

        function handleFileSelect(e) {
            if (e.target.files.length) handleFile(e.target.files[0]);
        }

        async function handleFile(file) {
            if (!file) return;
            const allowed = ['.csv', '.xlsx', '.xls', '.pdf'];
            const ext = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowed.includes(ext)) {
                showToast('Please upload CSV, Excel, or PDF');
                return;
            }
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.innerHTML = `
                <div class="upload-loading">
                    <div class="spinner"></div>
                    <div class="upload-text">Analyzing your statement...</div>
                    <div class="upload-subtitle">This may take a few moments</div>
                </div>
            `;
            try {
                const formData = new FormData();
                formData.append('file', file);
                if (selectedCardId) {
                    formData.append('card_id', selectedCardId);
                }
                const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:8000' 
                    : window.location.origin;
                const response = await fetch(`${API_BASE_URL}/api/analyze`, {
                    method: 'POST',
                    body: formData,
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Upload failed: ${response.status}`);
                }
                const result = await response.json();
                if (result.success) {
                    localStorage.setItem('cardmax_analysis', JSON.stringify(result.data));
                    showDashboard(result.data);
                    showToast('Analysis complete!');
                } else {
                    throw new Error(result.error || 'Analysis failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showToast('Error: ' + error.message);
                setTimeout(() => {
                    uploadZone.innerHTML = `
                        <div class="upload-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                        </div>
                        <div class="upload-text">Drop your statement here</div>
                        <div class="upload-subtitle">or click to browse (PDF, CSV, Excel)</div>
                    `;
                }, 3000);
            }
        }

        const uploadZone = document.getElementById('uploadZone');
        if (uploadZone) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => {
                    uploadZone.classList.add('dragover');
                });
            });
            ['dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => {
                    uploadZone.classList.remove('dragover');
                });
            });
            uploadZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) handleFile(files[0]);
            });
            uploadZone.addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function formatCurrency(amount) {
            if (!amount || amount === 0) return '₹0';
            return '₹' + Math.round(amount).toLocaleString('en-IN');
        }

        function showDashboard(data) {
            document.getElementById('uploadSection').style.display = 'none';
            const dashboard = document.getElementById('dashboardMain');
            dashboard.style.display = 'block';
            dashboard.classList.add('active');

            const totals = data.totals || {};
            const categoryTotals = data.category_totals || {};
            const transactions = data.transactions || [];

            const totalSpend = totals.total_spend || 0;
            const currentCardId = localStorage.getItem('cardmax_selected_card_id') || 'other';

            const userCardRewards = calculateCardRewards(currentCardId, categoryTotals, 'cash');
            const allCards = findBestCards(categoryTotals);
            const bestCard = allCards[0];

            const missedRewardsMonthly = Math.max(0, bestCard.monthly_rewards - userCardRewards.monthly_rewards);
            const missedRewardsAnnual = missedRewardsMonthly * 12;

            document.getElementById('statTotal').textContent = formatCurrency(totalSpend);
            document.getElementById('statMissed').textContent = formatCurrency(missedRewardsAnnual);
            document.getElementById('statMissed').style.color = missedRewardsAnnual > 0 ? 'var(--red)' : 'var(--green)';
            document.getElementById('statSavings').textContent = formatCurrency(Math.max(0, bestCard.net_annual_benefit));
            document.getElementById('statTxns').textContent = totals.transaction_count || 0;
            document.getElementById('pieCenterValue').textContent = formatCurrency(totalSpend);

            createPieChart(categoryTotals);
            renderRealMonthlyTrend(transactions);
            renderRealRecommendations(allCards.slice(0, 3), userCardRewards, bestCard);
            renderTransactions(transactions);

            dashboard.scrollIntoView({ behavior: 'smooth' });
        }

        function createPieChart(categories) {
            if (!categories || Object.keys(categories).length === 0) {
                document.getElementById('pieLegend').innerHTML = '<div style="color: var(--text-light); text-align: center; padding: 40px;">No spending data available</div>';
                return;
            }

            const sorted = Object.entries(categories)
                .filter(([cat, amount]) => amount > 100 && cat !== 'CASHBACK')
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (sorted.length === 0) {
                document.getElementById('pieLegend').innerHTML = '<div style="color: var(--text-light); text-align: center; padding: 40px;">No spending data available</div>';
                return;
            }

            const total = sorted.reduce((sum, [, amount]) => sum + amount, 0);
            const colors = ['#d4a574', '#7c9a6b', '#8b7aa8', '#c45c4a', '#5c4d3c'];

            const svg = document.getElementById('pieSvg');
            const tooltip = document.getElementById('pieTooltip');
            const legend = document.getElementById('pieLegend');

            svg.innerHTML = '';
            legend.innerHTML = '';

            let currentAngle = 0;
            const centerX = 50;
            const centerY = 50;
            const radius = 40;

            sorted.forEach(([category, amount], i) => {
                const percentage = (amount / total) * 100;
                const angle = (amount / total) * 360;
                const color = colors[i % colors.length];

                const startAngle = (currentAngle - 90) * Math.PI / 180;
                const endAngle = (currentAngle + angle - 90) * Math.PI / 180;

                const x1 = centerX + radius * Math.cos(startAngle);
                const y1 = centerY + radius * Math.sin(startAngle);
                const x2 = centerX + radius * Math.cos(endAngle);
                const y2 = centerY + radius * Math.sin(endAngle);

                const largeArc = angle > 180 ? 1 : 0;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const d = `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`;

                path.setAttribute('d', d);
                path.setAttribute('fill', color);
                path.setAttribute('stroke', 'white');
                path.setAttribute('stroke-width', '2');
                path.classList.add('pie-segment');

                path.addEventListener('mouseenter', () => {
                    tooltip.innerHTML = `<strong>${category.replace(/_/g, ' ')}</strong><br>${percentage.toFixed(1)}% · ${formatCurrency(amount)}`;
                    tooltip.classList.add('show');
                });

                path.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('show');
                });

                path.style.opacity = '0';
                path.style.transform = 'scale(0.8)';
                svg.appendChild(path);

                setTimeout(() => {
                    path.style.transition = 'all 0.5s cubic-bezier(0.23, 1, 0.32, 1)';
                    path.style.opacity = '1';
                    path.style.transform = 'scale(1)';
                }, i * 100);

                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background: ${color}"></div>
                    <div class="legend-text">
                        <span class="legend-label">${category.replace(/_/g, ' ')}</span>
                        <span class="legend-percent">${percentage.toFixed(1)}% · ${formatCurrency(amount)}</span>
                    </div>
                `;

                legendItem.addEventListener('mouseenter', () => {
                    path.style.transform = 'scale(1.05)';
                    path.style.filter = 'drop-shadow(0 8px 16px rgba(0,0,0,0.2))';
                });

                legendItem.addEventListener('mouseleave', () => {
                    path.style.transform = 'scale(1)';
                    path.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))';
                });

                legend.appendChild(legendItem);

                currentAngle += angle;
            });
        }

        function renderRealMonthlyTrend(transactions) {
            const monthlyData = {};

            transactions.forEach(t => {
                if (t.type === 'Debit' && t.date) {
                    const date = new Date(t.date);
                    const monthKey = date.toLocaleString('en-IN', { month: 'short' });
                    monthlyData[monthKey] = (monthlyData[monthKey] || 0) + (t.amount || 0);
                }
            });

            const sortedMonths = Object.entries(monthlyData)
                .sort((a, b) => {
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return months.indexOf(a[0]) - months.indexOf(b[0]);
                })
                .slice(-6);

            const months = sortedMonths.map(([m]) => m);
            const values = sortedMonths.map(([, v]) => v);
            const max = Math.max(...values, 1);

            const barIds = ['barFill1', 'barFill2', 'barFill3', 'barFill4', 'barFill5', 'barFill6'];
            const valIds = ['barVal1', 'barVal2', 'barVal3', 'barVal4', 'barVal5', 'barVal6'];
            const labelIds = ['barLabel1', 'barLabel2', 'barLabel3', 'barLabel4', 'barLabel5', 'barLabel6'];

            for (let i = 0; i < 6; i++) {
                const fill = document.getElementById(barIds[i]);
                const val = document.getElementById(valIds[i]);
                const label = document.getElementById(labelIds[i]);
                if (fill) fill.style.height = '0%';
                if (val) {
                    val.textContent = '₹0';
                    val.classList.remove('show');
                }
                if (label) label.textContent = '-';
            }

            months.forEach((month, i) => {
                if (i < 6) {
                    const height = (values[i] / max) * 100;
                    const fill = document.getElementById(barIds[i]);
                    const val = document.getElementById(valIds[i]);
                    const label = document.getElementById(labelIds[i]);

                    if (fill) {
                        setTimeout(() => {
                            fill.style.height = height + '%';
                        }, i * 100);
                    }
                    if (val) {
                        val.textContent = formatCurrency(values[i]);
                        val.classList.add('show');
                    }
                    if (label) label.textContent = month;
                }
            });
        }

        function renderRealRecommendations(topCards, userCard, bestCard) {
            const container = document.getElementById('recommendationCards');

            if (!topCards || topCards.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 40px;">No recommendations available</p>';
                return;
            }

            container.innerHTML = topCards.map((card, i) => {
                const isUsersCard = card.card_name === userCard.card_name;
                const isBest = i === 0;
                const hasWarnings = card.eligibility && card.eligibility.warnings.length > 0;

                return `
                    <div class="rec-card ${isBest ? 'best' : ''} ${isUsersCard ? 'current' : ''}">
                        ${isUsersCard ? '<div class="current-badge">YOUR CARD</div>' : ''}
                        <div class="rec-rank">${i + 1}</div>
                        <div class="rec-name">${card.card_name}</div>
                        <div class="rec-bank">Annual Fee: ${formatCurrency(card.annual_fee)}</div>
                        ${hasWarnings ? `
                            <div style="font-size: 11px; color: var(--red); margin-bottom: 12px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                                ⚠️ ${card.eligibility.warnings[0]}
                            </div>
                        ` : ''}
                        <div class="rec-stats">
                            <div class="rec-stat">
                                <span class="rec-stat-value">${formatCurrency(card.monthly_rewards)}</span>
                                <span class="rec-stat-label">Monthly Rewards</span>
                            </div>
                            <div class="rec-stat">
                                <span class="rec-stat-value ${card.net_annual_benefit > 0 ? 'positive' : ''}">${formatCurrency(card.net_annual_benefit)}</span>
                                <span class="rec-stat-label">Net Annual Benefit</span>
                            </div>
                        </div>
                        <div class="rec-fee">Based on your spending pattern</div>
                    </div>
                `;
            }).join('');
        }

        function renderTransactions(transactions) {
            const container = document.getElementById('transactionsList');

            if (!transactions || transactions.length === 0) {
                container.innerHTML = '<div style="color: var(--text-light); text-align: center; padding: 40px;">No transactions found</div>';
                return;
            }

            const sorted = transactions
                .filter(t => t.type === 'Debit')
                .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0))
                .slice(0, 10);

            const categoryIcons = {
                'FOOD_DINING': '🍽️',
                'SHOPPING': '🛍️',
                'TRAVEL': '✈️',
                'ENTERTAINMENT': '🎬',
                'UTILITIES': '💡',
                'GROCERIES': '🛒',
                'HEALTH': '⚕️',
                'FUEL': '⛽',
                'OTHER': '💳'
            };

            container.innerHTML = sorted.map(t => `
                <div class="table-row">
                    <div class="merchant-cell">
                        <div class="merchant-icon">${categoryIcons[t.category] || '💳'}</div>
                        <span class="merchant-name">${t.merchant || t.description || 'Unknown'}</span>
                    </div>
                    <div>
                        <span class="category-badge">${(t.category || 'Other').replace(/_/g, ' ').toLowerCase()}</span>
                    </div>
                    <div style="color: var(--text-light); font-size: 14px;">${t.date || '-'}</div>
                    <div class="amount-cell">${formatCurrency(t.amount)}</div>
                </div>
            `).join('');
        }

        function showEmptyState() {
            document.getElementById('statTotal').textContent = '₹0';
            document.getElementById('statMissed').textContent = '₹0';
            document.getElementById('statMissed').style.color = 'var(--red)';
            document.getElementById('statSavings').textContent = '₹0';
            document.getElementById('statTxns').textContent = '0';
            document.getElementById('pieCenterValue').textContent = '₹0';

            for (let i = 1; i <= 6; i++) {
                const fill = document.getElementById('barFill' + i);
                const val = document.getElementById('barVal' + i);
                const label = document.getElementById('barLabel' + i);
                if (fill) fill.style.height = '0%';
                if (val) {
                    val.textContent = '₹0';
                    val.classList.remove('show');
                }
                if (label) label.textContent = '-';
            }

            document.getElementById('pieSvg').innerHTML = '';
            document.getElementById('pieLegend').innerHTML = '<div style="color: var(--text-light); text-align: center; padding: 40px;">Upload a statement to see your spending breakdown</div>';
            document.getElementById('recommendationCards').innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 40px;">Complete analysis to see card recommendations</p>';
            document.getElementById('transactionsList').innerHTML = '<div style="color: var(--text-light); text-align: center; padding: 40px;">No transactions to display</div>';
        }

        function resetAnalysis() {
            localStorage.removeItem('cardmax_analysis');
            localStorage.removeItem('cardmax_selected_bank');
            localStorage.removeItem('cardmax_selected_card');
            localStorage.removeItem('cardmax_selected_card_id');

            selectedBank = null;
            selectedCard = null;
            selectedCardId = null;

            const dashboard = document.getElementById('dashboardMain');
            dashboard.classList.remove('active');
            dashboard.style.display = 'none';

            document.getElementById('uploadSection').style.display = 'flex';

            document.getElementById('bankPlaceholder').textContent = 'Choose your bank...';
            document.getElementById('bankPlaceholder').classList.add('placeholder');
            document.getElementById('stepCard').classList.remove('active');
            document.getElementById('selectedCardDisplay').classList.remove('active');

            const uploadZone = document.getElementById('uploadZone');
            uploadZone.classList.remove('active');
            uploadZone.innerHTML = `
                <div class="upload-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </div>
                <div class="upload-text">Drop your statement here</div>
                <div class="upload-subtitle">or click to browse (PDF, CSV, Excel)</div>
            `;

            showEmptyState();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast('Ready for new analysis');
        }

        window.addEventListener('load', () => {
            const saved = localStorage.getItem('cardmax_analysis');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.totals && data.totals.total_spend > 0) {
                        showDashboard(data);
                    } else {
                        showEmptyState();
                    }
                } catch(e) {
                    localStorage.removeItem('cardmax_analysis');
                    showEmptyState();
                }
            } else {
                showEmptyState();
            }
        });
    </script>
</body>
</html>